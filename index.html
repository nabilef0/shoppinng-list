<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopping List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3D8sfEXhHHFFySCl7YVqdn0WhjUVJqWw",
      authDomain: "shopping-list-c261f.firebaseapp.com",
      databaseURL: "https://shopping-list-c261f-default-rtdb.firebaseio.com",
      projectId: "shopping-list-c261f",
      storageBucket: "shopping-list-c261f.firebasestorage.app",
      messagingSenderId: "103318344059",
      appId: "1:103318344059:web:8c63c26212addf5054adde"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getDatabase(app);

    let currentUser = null;
    let items = [];

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("userInfo").innerText = `Halo, ${user.displayName}`;
        document.getElementById("authArea").classList.add("hidden");
        document.getElementById("mainArea").classList.remove("hidden");
        await loadData();
      } else {
        currentUser = null;
        document.getElementById("userInfo").innerText = "";
        document.getElementById("authArea").classList.remove("hidden");
        document.getElementById("mainArea").classList.add("hidden");
      }
    });

    document.getElementById("loginBtn").onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert("Login gagal: " + err.message);
      }
    };

    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
    };

    async function loadData() {
      const uid = currentUser.uid;
      const snapshot = await get(child(ref(db), `shoppingLists/${uid}`));
      if (snapshot.exists()) {
        items = snapshot.val() || [];
      } else {
        items = [];
      }
      renderList();
    }

    async function saveData() {
      const uid = currentUser.uid;
      await set(ref(db, `shoppingLists/${uid}`), items);
    }

    window.addItem = async function () {
      const name = document.getElementById("itemName").value.trim();
      const price = parseFloat(document.getElementById("itemPrice").value);
      const category = document.getElementById("itemCategory").value.trim();
      if (!name || isNaN(price)) return;

      items.push({ name, price, category });
      await saveData();
      renderList();

      document.getElementById("itemName").value = "";
      document.getElementById("itemPrice").value = "";
      document.getElementById("itemCategory").value = "";
    };

    window.renderList = function () {
      const filter = document.getElementById("filterCategory").value.trim().toLowerCase();
      const listEl = document.getElementById("shoppingList");
      const totalEl = document.getElementById("totalPrice");
      listEl.innerHTML = "";
      let total = 0;

      items.forEach((item, index) => {
        if (filter && item.category.toLowerCase() !== filter) return;

        const li = document.createElement("li");
        li.className = "bg-gray-200 p-3 rounded flex justify-between items-center";

        const left = document.createElement("div");

        const nameInput = document.createElement("input");
        nameInput.value = item.name;
        nameInput.className = "bg-transparent font-semibold w-32";
        nameInput.onchange = async () => {
          items[index].name = nameInput.value;
          await saveData();
        };

        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.value = item.price;
        priceInput.className = "bg-transparent w-24 ml-2";
        priceInput.onchange = async () => {
          items[index].price = parseFloat(priceInput.value);
          await saveData();
          renderList();
        };

        const catSpan = document.createElement("span");
        if (item.category) {
          catSpan.textContent = `(${item.category})`;
          catSpan.className = "ml-2 text-sm text-gray-600";
        }

        left.appendChild(nameInput);
        left.appendChild(priceInput);
        left.appendChild(catSpan);

        const right = document.createElement("div");
        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ•";
        delBtn.className = "text-red-500 font-bold ml-4 hover:text-red-700";
        delBtn.onclick = async () => {
          items.splice(index, 1);
          await saveData();
          renderList();
        };

        right.appendChild(delBtn);
        li.appendChild(left);
        li.appendChild(right);
        listEl.appendChild(li);

        total += parseFloat(item.price);
      });

      totalEl.textContent = total.toLocaleString("id-ID");
    };

    window.clearAll = async function () {
      if (confirm("Yakin ingin menghapus semua item?")) {
        items = [];
        await saveData();
        renderList();
      }
    };
  </script>
</head>
<body class="bg-gray-100 text-gray-800 p-6">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <div id="authArea" class="text-center">
      <h1 class="text-2xl font-bold mb-4">Login dulu</h1>
      <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login Google</button>
    </div>

    <div id="mainArea" class="hidden">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">ðŸ›’ Shopping List</h1>
        <div>
          <span id="userInfo" class="text-sm mr-2"></span>
          <button id="logoutBtn" class="text-red-600 text-sm">Logout</button>
        </div>
      </div>

      <div class="space-y-3">
        <input id="itemName" type="text" placeholder="Nama barang" class="w-full border p-2 rounded" />
        <input id="itemPrice" type="number" placeholder="Harga" class="w-full border p-2 rounded" />
        <input id="itemCategory" type="text" placeholder="Kategori (misal: Makanan)" class="w-full border p-2 rounded" />
        <button onclick="addItem()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Tambah</button>
      </div>

      <div class="mt-6">
        <label for="filterCategory" class="block mb-1 text-sm">Filter kategori:</label>
        <input id="filterCategory" type="text" oninput="renderList()" placeholder="Semua / Makanan / Minuman..." class="w-full border p-2 rounded mb-4" />
      </div>

      <ul id="shoppingList" class="space-y-2"></ul>

      <div class="text-lg font-semibold mt-4">Total: Rp <span id="totalPrice">0</span></div>
      <button onclick="clearAll()" class="mt-4 w-full bg-red-600 text-white p-2 rounded hover:bg-red-700">Hapus Semua</button>
    </div>
  </div>
</body>
</html>
